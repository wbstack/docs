(window.webpackJsonp=window.webpackJsonp||[]).push([[41],{409:function(e,t,a){"use strict";a.r(t);var r=a(24),s=Object(r.a)({},(function(){var e=this,t=e.$createElement,a=e._self._c||t;return a("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[a("h1",{attrs:{id:"cert-manager"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#cert-manager"}},[e._v("#")]),e._v(" Cert Manager")]),e._v(" "),a("p",[a("a",{attrs:{href:"https://cert-manager.io/",target:"_blank",rel:"noopener noreferrer"}},[e._v("cert-manager"),a("OutboundLink")],1),e._v(" provides automatic certificate management in Kubernetes.")]),e._v(" "),a("p",[e._v('Simply put, you can define "Certificate" resources in Kubernetes, and cert-manager will go to an ACME provider for the certificate, dealing with DNS or HTTP verification of the domain using an ingress.')]),e._v(" "),a("p",[e._v("Further Reading:")]),e._v(" "),a("ul",[a("li",[a("a",{attrs:{href:"https://docs.cert-manager.io/en/release-0.10/tutorials/acme/quick-start/index.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("Quickstart with nginx ingress"),a("OutboundLink")],1)]),e._v(" "),a("li",[a("a",{attrs:{href:"https://docs.cert-manager.io/en/latest/tasks/issuers/setup-acme/dns01/google.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("gcloud dns01 issuer docs"),a("OutboundLink")],1)]),e._v(" "),a("li",[a("a",{attrs:{href:"https://cert-manager.io/docs/usage/kubectl-plugin/",target:"_blank",rel:"noopener noreferrer"}},[e._v("kubectl plugin"),a("OutboundLink")],1)])]),e._v(" "),a("h2",{attrs:{id:"installation"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#installation"}},[e._v("#")]),e._v(" Installation")]),e._v(" "),a("div",{staticClass:"custom-block warning"},[a("p",{staticClass:"custom-block-title"},[e._v("WARNING")]),e._v(" "),a("p",[e._v("cert-manager currently has a bit of a cumbersome setup requiring custom resource definitions and multiple helmfile deployments.")])]),e._v(" "),a("h3",{attrs:{id:"definitions"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#definitions"}},[e._v("#")]),e._v(" Definitions")]),e._v(" "),a("p",[e._v('First you need to apply some of the static "definitions" to the Kubernetes cluster.')]),e._v(" "),a("p",[e._v("These can all be found in the deploy repo "),a("a",{attrs:{href:"https://github.com/wbstack/deploy/tree/main/k8s/definitions/cert-manager",target:"_blank",rel:"noopener noreferrer"}},[e._v("k8s/definitions/cert-manager directory"),a("OutboundLink")],1),e._v(".")]),e._v(" "),a("ul",[a("li",[a("strong",[e._v("00-namespace.yaml")]),e._v(" - A namespace for the cert-manager deployment to live in.")]),e._v(" "),a("li",[a("strong",[e._v("01-crds.yaml")]),e._v(" - The CRDs for cert-manager (Custom Resource definitions)")]),e._v(" "),a("li",[a("strong",[e._v("02-certificates-*.yaml")]),e._v(" - The certificates for our domains (See warning below)")])]),e._v(" "),a("h3",{attrs:{id:"service-account"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#service-account"}},[e._v("#")]),e._v(" Service account")]),e._v(" "),a("p",[e._v("A Google Cloud service account is required so that cert-manager can interace with the Google DNS.")]),e._v(" "),a("p",[e._v("In WBStack production this service account was created with deployment manager.\nYou can find the old code for this "),a("a",{attrs:{href:"https://github.com/wbstack/deploy/tree/main/gce/serviceaccounts",target:"_blank",rel:"noopener noreferrer"}},[e._v("here"),a("OutboundLink")],1),e._v(".")]),e._v(" "),a("p",[e._v("The service account needs:")]),e._v(" "),a("ul",[a("li",[a("strong",[e._v("Name:")]),e._v(" certman-dns01-solver")]),e._v(" "),a("li",[a("strong",[e._v("Role:")]),e._v(" roles/dns.admin")])]),e._v(" "),a("p",[e._v("Once the service account has been created you need to get a key for the account and create it as a Kubernetes secret.\nSome sample commands for doing this are below:")]),e._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[e._v("gcloud iam service-accounts keys create ./certman-dns01-solver-1.json --iam-account certman-dns01-solver@wbstack.iam.gserviceaccount.com\nkubectl create secret generic clouddns-dns01-solver-svc-acct --namespace"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("cert-manager --from-file"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("key.json"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("./certman-dns01-solver-1.json --dry-run"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("true --output"),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v("=")]),e._v("yaml "),a("span",{pre:!0,attrs:{class:"token operator"}},[e._v(">")]),e._v(" ./clouddns-dns01-solver-svc-acct.yaml\nkubectl apply -f ./clouddns-dns01-solver-svc-acct.yaml\n")])])]),a("div",{staticClass:"custom-block tip"},[a("p",{staticClass:"custom-block-title"},[e._v("TIP")]),e._v(" "),a("p",[e._v("This secret name will be used in the CLusterIssuers below.")])]),e._v(" "),a("h3",{attrs:{id:"helmfiles"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#helmfiles"}},[e._v("#")]),e._v(" Helmfiles")]),e._v(" "),a("p",[e._v("The helmfile deployment is currently split in 2:")]),e._v(" "),a("ul",[a("li",[a("strong",[e._v("clusterissuers")]),e._v(" - helmified definitions of ClusterIssuers, that allow cert-manager to actually fetch certificates.")]),e._v(" "),a("li",[a("strong",[e._v("cert-manager")]),e._v(" - The actual cert-manager service deployment.")])]),e._v(" "),a("p",[e._v("These can be applied using the standard "),a("a",{attrs:{href:"/tech/k8s/helm"}},[e._v("helm methods")]),e._v(".")]),e._v(" "),a("h3",{attrs:{id:"debugging"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#debugging"}},[e._v("#")]),e._v(" Debugging")]),e._v(" "),a("p",[a("a",{attrs:{href:"https://docs.cert-manager.io/en/latest/reference/orders.html",target:"_blank",rel:"noopener noreferrer"}},[e._v("https://docs.cert-manager.io/en/latest/reference/orders.html"),a("OutboundLink")],1)]),e._v(" "),a("p",[e._v("See the certificate for the main domain:")]),e._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[e._v("kubectl describe certificate wbstack-com-tls\n")])])]),a("p",[e._v("This will list the current status and any current orders that are occurring.")]),e._v(" "),a("p",[e._v("You can then get the details of the order:")]),e._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[e._v("kubectl describe order wbstack-com-tls-356876054\n")])])]),a("p",[e._v("Which will list a collection of challenges.")]),e._v(" "),a("p",[e._v("You can see the details of the challenges")]),e._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[e._v("kubectl describe challenge wbstack-com-tls-356876054-0\nkubectl describe challenge wbstack-com-tls-356876054-1\n")])])]),a("p",[e._v("You can see if DNS challenges have made it to Google Cloud DNS by going to:")]),e._v(" "),a("p",[a("code",[e._v("https://console.cloud.google.com/net-services/dns?cloudshell=false&project=<projectname>")])])])}),[],!1,null,null,null);t.default=s.exports}}]);