(window.webpackJsonp=window.webpackJsonp||[]).push([[46],{412:function(s,e,a){"use strict";a.r(e);var t=a(24),r=Object(t.a)({},(function(){var s=this,e=s.$createElement,a=s._self._c||e;return a("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[a("h1",{attrs:{id:"persistence"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#persistence"}},[s._v("#")]),s._v(" Persistence")]),s._v(" "),a("h2",{attrs:{id:"sql"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#sql"}},[s._v("#")]),s._v(" sql")]),s._v(" "),a("p",[s._v("An sql service running MariaDB operates for both the main platform API and MediaWiki sites.")]),s._v(" "),a("p",[s._v("This is currently setup with replication enabled.")]),s._v(" "),a("h2",{attrs:{id:"elasticsearch"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#elasticsearch"}},[s._v("#")]),s._v(" elasticsearch")]),s._v(" "),a("p",[s._v("An elasticsearch service, using the WMDE Wikibase flavours elastic search docker image operates for use by MediaWiki and Wikibase.")]),s._v(" "),a("p",[s._v("This is currently setup in a cluster of 3.")]),s._v(" "),a("h2",{attrs:{id:"redis"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#redis"}},[s._v("#")]),s._v(" redis")]),s._v(" "),a("p",[s._v("Redis is used by a variety of deployed services for:")]),s._v(" "),a("ul",[a("li",[s._v("caching")]),s._v(" "),a("li",[s._v("queues")]),s._v(" "),a("li",[s._v("shared sessions")])]),s._v(" "),a("h3",{attrs:{id:"cli-access"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#cli-access"}},[s._v("#")]),s._v(" CLI access")]),s._v(" "),a("p",[s._v("Start bash:")]),s._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[s._v("k8s/cmd/bash-redis-slave.sh\n")])])]),a("p",[s._v("Start client:")]),s._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[s._v("redis-cli\n")])])]),a("p",[s._v("Login:")]),s._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[s._v("AUTH "),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<")]),s._v("password"),a("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v("\n")])])]),a("p",[s._v("Select a DB:")]),s._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[s._v("SELECT "),a("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n")])])]),a("p",[s._v("List all keys:")]),s._v(" "),a("div",{staticClass:"language-sh extra-class"},[a("pre",{pre:!0,attrs:{class:"language-sh"}},[a("code",[s._v("KEYS *\n")])])]),a("p",[s._v("See more commands: https://redis.io/commands")]),s._v(" "),a("h3",{attrs:{id:"redis-databases"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#redis-databases"}},[s._v("#")]),s._v(" Redis Databases")]),s._v(" "),a("ul",[a("li",[s._v("0 = mediawiki")]),s._v(" "),a("li",[s._v("2 = api (db)")]),s._v(" "),a("li",[s._v("3 = api (cacheDb)")]),s._v(" "),a("li",[s._v("10 = tool-quickstatements")]),s._v(" "),a("li",[s._v("11 = tool-widar")])]),s._v(" "),a("h3",{attrs:{id:"append-only-file"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#append-only-file"}},[s._v("#")]),s._v(" Append only file")]),s._v(" "),a("p",[s._v("Redis stores its state in an append only file (choice by configuration).\nThis file naturally will slowly get bigger and bigger.\nIt SHOULD rebuild itself restricting its size once it goes over some configured value (see helm config map).")]),s._v(" "),a("h3",{attrs:{id:"decreasing-memory-allocation"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#decreasing-memory-allocation"}},[s._v("#")]),s._v(" Decreasing memory allocation")]),s._v(" "),a("ul",[a("li",[s._v("Decrease memory allocation in redis")]),s._v(" "),a("li",[s._v("restart redis")]),s._v(" "),a("li",[s._v("Trim AOF - https://redis.io/commands/bgrewriteaof")]),s._v(" "),a("li",[s._v("Decrease memory request and limit in k8s")])]),s._v(" "),a("p",[s._v("If these steps are not followed then you might end up in an OOM crash loop as redis tries to run through all of the file..")])])}),[],!1,null,null,null);e.default=r.exports}}]);