<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>One WDQS server vs a cluster | WBStack</title>
    <meta name="generator" content="VuePress 1.8.2">
    
    <meta name="description" content="Documentation site for WBStack">
    <meta name="theme-color" content="#3eaf7c">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    
    <link rel="preload" href="/assets/css/0.styles.f3f98661.css" as="style"><link rel="preload" href="/assets/js/app.751ddebd.js" as="script"><link rel="preload" href="/assets/js/2.d7597798.js" as="script"><link rel="preload" href="/assets/js/20.5a7c335b.js" as="script"><link rel="prefetch" href="/assets/js/10.18320322.js"><link rel="prefetch" href="/assets/js/11.0891f683.js"><link rel="prefetch" href="/assets/js/12.9c1d8c5a.js"><link rel="prefetch" href="/assets/js/13.e506444f.js"><link rel="prefetch" href="/assets/js/14.32e0fc04.js"><link rel="prefetch" href="/assets/js/15.5e13bf42.js"><link rel="prefetch" href="/assets/js/16.a81ac360.js"><link rel="prefetch" href="/assets/js/17.a79f7db5.js"><link rel="prefetch" href="/assets/js/18.6c5bd850.js"><link rel="prefetch" href="/assets/js/19.1b016d38.js"><link rel="prefetch" href="/assets/js/21.11e19e43.js"><link rel="prefetch" href="/assets/js/22.bb79fcc1.js"><link rel="prefetch" href="/assets/js/23.67fa322e.js"><link rel="prefetch" href="/assets/js/24.2555ab51.js"><link rel="prefetch" href="/assets/js/25.2ffaad60.js"><link rel="prefetch" href="/assets/js/26.7edb7b0e.js"><link rel="prefetch" href="/assets/js/27.382d4fd4.js"><link rel="prefetch" href="/assets/js/28.2996ce31.js"><link rel="prefetch" href="/assets/js/29.3c442902.js"><link rel="prefetch" href="/assets/js/3.72ce2306.js"><link rel="prefetch" href="/assets/js/30.93f6cd16.js"><link rel="prefetch" href="/assets/js/31.ea63f9a1.js"><link rel="prefetch" href="/assets/js/32.f17d81d4.js"><link rel="prefetch" href="/assets/js/33.f518b9a3.js"><link rel="prefetch" href="/assets/js/34.1d5d4812.js"><link rel="prefetch" href="/assets/js/35.41158f80.js"><link rel="prefetch" href="/assets/js/36.91ed0fc3.js"><link rel="prefetch" href="/assets/js/37.cc32c2a5.js"><link rel="prefetch" href="/assets/js/38.245b516b.js"><link rel="prefetch" href="/assets/js/39.c71dea4a.js"><link rel="prefetch" href="/assets/js/4.6eb5a754.js"><link rel="prefetch" href="/assets/js/40.1156b4f8.js"><link rel="prefetch" href="/assets/js/41.86e26636.js"><link rel="prefetch" href="/assets/js/42.be99d387.js"><link rel="prefetch" href="/assets/js/43.a07c72c1.js"><link rel="prefetch" href="/assets/js/44.ea3b790a.js"><link rel="prefetch" href="/assets/js/45.ede7a59e.js"><link rel="prefetch" href="/assets/js/46.bb37262e.js"><link rel="prefetch" href="/assets/js/47.01c169fc.js"><link rel="prefetch" href="/assets/js/48.8e07b91b.js"><link rel="prefetch" href="/assets/js/49.0e268fb7.js"><link rel="prefetch" href="/assets/js/5.d74740a2.js"><link rel="prefetch" href="/assets/js/50.af335508.js"><link rel="prefetch" href="/assets/js/51.a6452493.js"><link rel="prefetch" href="/assets/js/52.8e039987.js"><link rel="prefetch" href="/assets/js/53.8aca6647.js"><link rel="prefetch" href="/assets/js/54.f2a0b93a.js"><link rel="prefetch" href="/assets/js/55.85bed42b.js"><link rel="prefetch" href="/assets/js/56.42ee4c6a.js"><link rel="prefetch" href="/assets/js/57.7f09cde0.js"><link rel="prefetch" href="/assets/js/6.d8611671.js"><link rel="prefetch" href="/assets/js/7.93e686c3.js"><link rel="prefetch" href="/assets/js/8.791a3f75.js"><link rel="prefetch" href="/assets/js/9.160da74a.js">
    <link rel="stylesheet" href="/assets/css/0.styles.f3f98661.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">WBStack</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/about/" class="nav-link">
  About
</a></div><div class="nav-item"><a href="/tech/" class="nav-link router-link-active">
  Tech Docs
</a></div><div class="nav-item"><a href="/users/" class="nav-link">
  User Docs
</a></div><div class="nav-item"><a href="https://wikibase.cloud" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Wikibase.cloud
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://www.github.com/wbstack" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/about/" class="nav-link">
  About
</a></div><div class="nav-item"><a href="/tech/" class="nav-link router-link-active">
  Tech Docs
</a></div><div class="nav-item"><a href="/users/" class="nav-link">
  User Docs
</a></div><div class="nav-item"><a href="https://wikibase.cloud" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Wikibase.cloud
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div><div class="nav-item"><a href="https://www.github.com/wbstack" target="_blank" rel="noopener noreferrer" class="nav-link external">
  Github
  <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>General</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Google Cloud</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Kubernetes</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Services</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading open"><span>Decision Records</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/tech/decisions/" aria-current="page" class="sidebar-link">Overview</a></li><li><a href="/tech/decisions/0000-gce-vs-other-k8s-cluster.html" class="sidebar-link">GCE vs other Kubernetes clusters</a></li><li><a href="/tech/decisions/0001-gce-kubernetes-cluster-private-vs-public.html" class="sidebar-link">Private vs Public GCE kubernetes cluster</a></li><li><a href="/tech/decisions/0002-gce-ingress-vs-nginx.html" class="sidebar-link">GCE Ingress vs Nginx</a></li><li><a href="/tech/decisions/0003-vitess-vs-mysql.html" class="sidebar-link">Vitess vs Mysql / Mariadb</a></li><li><a href="/tech/decisions/0004-one-wdqs-vs-cluster.html" aria-current="page" class="active sidebar-link">One WDQS server vs a cluster</a></li><li><a href="/tech/decisions/0005-backend-apis-and-services.html" class="sidebar-link">Backend APIs and Services</a></li><li><a href="/tech/decisions/0006-wiki-access.html" class="sidebar-link">Public access of Wikis</a></li><li><a href="/tech/decisions/0008-custom-domains-ingress-creation.html" class="sidebar-link">Custom domain ingress creation</a></li><li><a href="/tech/decisions/0009-api-using-laravel.html" class="sidebar-link">API using Laravel framework</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="one-wdqs-server-vs-a-cluster"><a href="#one-wdqs-server-vs-a-cluster" class="header-anchor">#</a> One WDQS server vs a cluster</h1> <div class="custom-block warning"><p class="custom-block-title">WARNING</p> <p>This decision document has not yet been formatted for nice display...</p></div> <p>Date: 27 August 2019
Decision: Single service, namespace &amp; prefix adjusted, more complex later.</p> <p>A single WDQS server can host the whole of wikidata, so size isn't going to be an
issue starting out.
Number of requests should also be fairly low, so no need to worry here yet.
Also the complexity of queries should be fairly low as most data sets should be small.</p> <p>It should be easy to spot growth in this area and easy to adapt to changes.</p> <p>If the JNL breaks, initially it shouldn't be too hard to reload ALL of the data for
all of the wikis. And this could be expected in Alpha...</p> <p>If number of READ queries is too much then we need another copy with the same data set.
This can easily be done by:</p> <ul><li>Dumping the current jnl.</li> <li>Either by stopping the service, taking a copy, and turning it back on</li> <li>Or https://wiki.blazegraph.com/wiki/index.php/REST_API#Online_Backup</li> <li>Alter the current updater to write to both servers and track the status seperalty?</li> <li>OR have 2 updaters?</li> <li>PROFIT</li></ul> <p>If number of WRITES is too much then we may need to split the namespaces across
more than one WDQS instances.
This could be done with:</p> <ul><li>The same steps as above to create 2 copies of the current service.</li> <li>Destroy the namespaces we don't want on the next shard https://wiki.blazegraph.com/wiki/index.php/REST_API#DESTROY_DATA_SET</li> <li>Create some load balancer / system that knows where each NS is</li> <li>Use LB to direct traffic to correct server</li> <li>Destroy namespaces from the first shard we don't need.
This again needs updater changes to write the correct things to the right server.</li></ul> <h3 id="gateway"><a href="#gateway" class="header-anchor">#</a> Gateway</h3> <p>The general idea would be to have some sort of gateway (similar to vitess)
The gateway knows:</p> <ul><li>How to map the outer prefix to inner prefixes (wikidata.org -&gt; abc123[dbname]</li> <li>This allows sites to be re-named without needing to reload all data?</li> <li>Which internal blazegraph endpoint to forward the request to based on the request</li> <li>Which internal blazegraph namespace to forward the request to based on the request</li></ul> <p>It might be worth giving https://www.blazegraph.com/whitepapers/bigdata_ha_whitepaper.pdf
a read..</p> <h3 id="operator"><a href="#operator" class="header-anchor">#</a> Operator</h3> <p>Further down the line it would be great to have a k8s operator to do all of this:</p> <ul><li>Sharding</li> <li>Scaling</li> <li>Replication / Updating</li> <li>Backups</li> <li>etc.</li></ul></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/wbstack/docs/edit/main/tech/decisions/0004-one-wdqs-vs-cluster.md" target="_blank" rel="noopener noreferrer">Edit this page on Github!</a> <span><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg> <span class="sr-only">(opens new window)</span></span></div> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">8/18/2022, 1:13:39 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/tech/decisions/0003-vitess-vs-mysql.html" class="prev">
        Vitess vs Mysql / Mariadb
      </a></span> <span class="next"><a href="/tech/decisions/0005-backend-apis-and-services.html">
        Backend APIs and Services
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.751ddebd.js" defer></script><script src="/assets/js/2.d7597798.js" defer></script><script src="/assets/js/20.5a7c335b.js" defer></script>
  </body>
</html>
